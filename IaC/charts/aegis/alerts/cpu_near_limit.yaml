apiVersion: 1
groups:
  - orgId: 1
    name: CPU Alerts
    folder: Aegis
    interval: 10s
    rules:
      - uid: cpu_near_limit
        title: CPU Near Limit
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              editorMode: code
              expr: (sum(rate(container_cpu_usage_seconds_total{namespace="demo"}[5m])) by (pod) / sum(kube_pod_container_resource_limits{namespace="demo", resource="cpu"}) by (pod)) > 0.9
              legendFormat: '{{pod}}'
              range: true
              intervalMs: 15000
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: "__expr__"
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.9
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    type: last
                  type: query
              type: classic_conditions
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          description: "{{ $labels.pod }} is using more than 90% of its CPU limit for 5 minutes."
          summary: "CPU usage near limit for {{ $labels.pod }}"
        labels:
          severity: warning
          category: resource